{% extends "base.html" %}
{% block content %}

<!-- üî¢ M√âTRICAS -->
<div class="row mb-4 text-center">
  <div class="col-md-4">
    <div class="card border-success shadow-sm">
      <div class="card-body">
        <h6 class="text-success">Importe Total</h6>
        <h3 class="fw-bold text-dark">${{ "{:,.2f}".format(total_importe) }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-primary shadow-sm">
      <div class="card-body">
        <h6 class="text-primary">Cotizaciones Totales</h6>
        <h3 class="fw-bold text-dark">{{ total_cotizaciones }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-info shadow-sm">
      <div class="card-body">
        <h6 class="text-info">Conceptos Registrados</h6>
        <h3 class="fw-bold text-dark">{{ total_catalogo }}</h3>
      </div>
    </div>
  </div>
</div>

<!-- üìä GR√ÅFICAS -->
<div class="row mt-4">
  <div class="col-md-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Evoluci√≥n Mensual de Cotizaciones</h5>
        <canvas id="chartMensual"></canvas>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Distribuci√≥n por Estatus</h5>
        <canvas id="chartEstatus"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- üìã TABLA DE COTIZACIONES + FILTROS -->
<div class="mt-5">
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">√öltimas Cotizaciones</h5>

      <!-- üîç FILTROS -->
      <div class="row g-2 align-items-end mb-3">
        <div class="col-md-3 col-6">
          <label class="form-label small fw-bold text-secondary mb-1">Desde</label>
          <input type="date" id="filtro-desde" class="form-control form-control-sm">
        </div>
        <div class="col-md-3 col-6">
          <label class="form-label small fw-bold text-secondary mb-1">Hasta</label>
          <input type="date" id="filtro-hasta" class="form-control form-control-sm">
        </div>
        <div class="col-md-3 col-6">
          <label class="form-label small fw-bold text-secondary mb-1">Estatus</label>
          <select id="filtro-estatus" class="form-select form-select-sm">
            <option value="">Todos</option>
            <option value="PENDIENTE">PENDIENTE</option>
            <option value="ENVIADA">ENVIADA</option>
            <option value="GANADA">GANADA</option>
            <option value="PERDIDA">PERDIDA</option>
          </select>
        </div>
        <div class="col-md-2 col-6">
          <label class="form-label small fw-bold text-secondary mb-1">Cliente / Empresa</label>
          <input type="text" id="filtro-cliente" class="form-control form-control-sm" placeholder="Buscar...">
        </div>
        <div class="col-md-1 text-end">
          <button id="btn-limpiar-filtros" class="btn btn-outline-secondary btn-sm w-100">üîÑ</button>
        </div>
      </div>

      <!-- üìã TABLA -->
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>Folio</th>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Empresa</th>
              <th>Total</th>
              <th>Estatus</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaCotizaciones">
            {% for c in cotizaciones %}
            <tr data-id="{{ c.id }}" 
                data-fecha="{{ c.fecha.strftime('%Y-%m-%d') }}"
                data-estatus="{{ c.estatus }}"
                data-cliente="{{ (c.cliente.nombre_cliente if c.cliente else '')|lower }}"
                data-empresa="{{ (c.cliente.empresa if c.cliente else '')|lower }}"
                class="status-row {{ c.estatus|lower }}">
              <td>{{ c.folio }}</td>
              <td>{{ c.fecha.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>{{ c.cliente.nombre_cliente if c.cliente else '' }}</td>
              <td>{{ c.cliente.empresa if c.cliente else '' }}</td>
              <td>${{ "{:,.2f}".format(c.total) }}</td>
              <td>
                <select class="status-select" onchange="cambiarEstatus({{ c.id }}, this)">
                  {% for estado in ['PENDIENTE','ENVIADA','GANADA','PERDIDA'] %}
                    <option value="{{ estado }}" {% if c.estatus == estado %}selected{% endif %}>{{ estado }}</option>
                  {% endfor %}
                </select>
              </td>
               <td class="text-center">
                <a href="{{ url_for('view_cotizacion', cot_id=c.id) }}" class="btn btn-outline-primary btn-sm" title="Ver">üëÅÔ∏è</a>
                <a href="{{ url_for('export_cotizacion_pdf', cot_id=c.id) }}" target="_blank" class="btn btn-outline-danger btn-sm" title="PDF">üìÑ</a>
                <a href="{{ url_for('export_cotizacion_xlsx', cot_id=c.id) }}" class="btn btn-outline-success btn-sm" title="Excel">üìä</a>
                <a href="{{ url_for('editar_cotizacion', cot_id=c.id) }}" class="btn btn-outline-warning btn-sm" title="Editar">‚úèÔ∏è</a>
                <a href="{{ url_for('eliminar_cotizacion', cot_id=c.id) }}" class="btn btn-outline-danger btn-sm" title="Eliminar">üóëÔ∏è</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- üìà SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// === CAMBIO DE ESTATUS INLINE ===
async function cambiarEstatus(id, select) {
  const nuevo = select.value;
  try {
    const res = await fetch(`/api/cotizaciones/${id}/estatus`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ estatus: nuevo }),
    });
    const data = await res.json();
    if (data.ok) {
      Swal.fire({
        icon: "success",
        title: "Estatus actualizado",
        text: `Nuevo estatus: ${nuevo}`,
        timer: 1200,
        showConfirmButton: false
      });
      actualizarColorFila(select.closest("tr"), nuevo);
    }
  } catch (err) {
    console.error(err);
  }
}

function actualizarColorFila(row, estatus) {
  row.classList.remove("table-success", "table-warning", "table-info", "table-danger");
  switch (estatus) {
    case "GANADA": row.classList.add("table-success"); break;
    case "PENDIENTE": row.classList.add("table-warning"); break;
    case "ENVIADA": row.classList.add("table-info"); break;
    case "PERDIDA": row.classList.add("table-danger"); break;
  }
}

// === FILTROS ===
document.addEventListener("DOMContentLoaded", () => {
  const desde = document.getElementById("filtro-desde");
  const hasta = document.getElementById("filtro-hasta");
  const estatus = document.getElementById("filtro-estatus");
  const cliente = document.getElementById("filtro-cliente");
  const limpiar = document.getElementById("btn-limpiar-filtros");
  const filas = document.querySelectorAll("#tablaCotizaciones tr");

  function filtrar() {
    const d = desde.value ? new Date(desde.value) : null;
    const h = hasta.value ? new Date(hasta.value) : null;
    const e = estatus.value;
    const c = cliente.value.trim().toLowerCase();

    filas.forEach(tr => {
      const f = new Date(tr.dataset.fecha);
      const est = tr.dataset.estatus;
      const cli = tr.dataset.cliente || "";
      const emp = tr.dataset.empresa || "";
      let visible = true;

      if (d && f < d) visible = false;
      if (h && f > h) visible = false;
      if (e && est !== e) visible = false;
      if (c && !(cli.includes(c) || emp.includes(c))) visible = false;

      tr.style.display = visible ? "" : "none";
    });
  }

  function limpiarFiltros() {
    [desde, hasta, estatus, cliente].forEach(el => el.value = "");
    filtrar();
  }

  [desde, hasta, estatus, cliente].forEach(el => el.addEventListener("input", filtrar));
  limpiar.addEventListener("click", limpiarFiltros);
});

// === ELIMINAR COTIZACI√ìN ===
async function eliminarCotizacion(id, folio) {
  const confirm = await Swal.fire({
    title: `¬øEliminar ${folio}?`,
    text: "Esta acci√≥n no se puede deshacer.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#d33",
    cancelButtonColor: "#3085d6",
    confirmButtonText: "S√≠, eliminar",
    cancelButtonText: "Cancelar"
  });

  if (confirm.isConfirmed) {
    try {
      const res = await fetch(`/api/cotizaciones/${id}/eliminar`, { method: "DELETE" });
      const data = await res.json();

      if (data.ok) {
        Swal.fire({
          icon: "success",
          title: "Eliminada",
          text: `Cotizaci√≥n ${folio} eliminada.`,
          timer: 1200,
          showConfirmButton: false
        });
        document.querySelector(`#tablaCotizaciones tr[data-id='${id}']`)?.remove();
      } else {
        Swal.fire("Error", data.error || "No se pudo eliminar.", "error");
      }
    } catch (e) {
      Swal.fire("Error", "No se pudo conectar con el servidor.", "error");
    }
  }
}

// === GR√ÅFICAS ===
async function cargarGraficas() {
  try {
    const res1 = await fetch("/api/dashboard/metrics");
    const data1 = await res1.json();

    const labels = data1.series.map(x => x.mes);
    const totales = data1.series.map(x => x.total);
    const cotizaciones = data1.series.map(x => x.cotizaciones);

    new Chart(document.getElementById("chartMensual"), {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: "Importe Total ($)", data: totales, backgroundColor: "#0d47a1", borderRadius: 6 },
          { label: "Cotizaciones", data: cotizaciones, backgroundColor: "#4caf50", borderRadius: 6 },
        ],
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } },
    });

    const res2 = await fetch("/api/dashboard/status_breakdown");
    const data2 = await res2.json();

    new Chart(document.getElementById("chartEstatus"), {
      type: "doughnut",
      data: {
        labels: data2.labels,
        datasets: [{ data: data2.counts, backgroundColor: ["#4caf50", "#ffeb3b", "#2196f3", "#f44336"] }],
      },
      options: { plugins: { legend: { position: "bottom" } } },
    });
  } catch (err) {
    console.error("Error cargando gr√°ficas", err);
  }
}

document.addEventListener("DOMContentLoaded", cargarGraficas);
</script>

{% endblock %}
