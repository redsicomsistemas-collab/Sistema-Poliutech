<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>M.A.R ‚Äî Sistema Poliutech ¬∑ Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f7f8fa; }
    .card { border-radius: 10px; }
    .status-select {
      border: none;
      background: transparent;
      font-weight: 500;
      color: #0d47a1;
    }
    nav a {
      text-decoration: none;
      color: white;
      margin-right: 20px;
      font-weight: 500;
    }
    nav a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body class="container-fluid py-4">

  <!-- üîµ HEADER (no fijo, baja con el scroll) -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary rounded shadow-sm mb-4 px-4" style="position: static;">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <img src="{{ url_for('static', filename='logo.jpg') }}" alt="Logo" height="45" class="me-3 rounded">
        <span class="navbar-brand mb-0 h5 fw-bold text-white">M.A.R ‚Äî Sistema Poliutech</span>
      </div>
      <div>
        <a href="{{ url_for('index') }}">üè† Dashboard</a>
        <a href="{{ url_for('cotizador') }}">üí∞ Cotizador</a>
        <a href="{{ url_for('admin_catalogos') }}">üìö Cat√°logos</a>        
      </div>
    </div>
  </nav>

  <!-- üî¢ M√âTRICAS -->
  <div class="row mb-4 text-center">
    <div class="col-md-4">
      <div class="card border-success shadow-sm">
        <div class="card-body">
          <h6 class="text-success">Importe Total</h6>
          <h3 class="fw-bold text-dark">${{ "{:,.2f}".format(total_importe) }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-primary shadow-sm">
        <div class="card-body">
          <h6 class="text-primary">Cotizaciones Totales</h6>
          <h3 class="fw-bold text-dark">{{ total_cotizaciones }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-info shadow-sm">
        <div class="card-body">
          <h6 class="text-info">Conceptos Registrados</h6>
          <h3 class="fw-bold text-dark">{{ total_catalogo }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- üìä GR√ÅFICAS -->
  <div class="row mt-4">
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Evoluci√≥n Mensual de Cotizaciones</h5>
          <canvas id="chartMensual"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Distribuci√≥n por Estatus</h5>
          <canvas id="chartEstatus"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- üìã TABLA DE COTIZACIONES -->
  <div class="mt-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3">√öltimas Cotizaciones</h5>
        <div class="table-responsive">
          <table class="table table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Folio</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Empresa</th>
                <th>Total</th>
                <th>Estatus</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaCotizaciones">
              {% for c in cotizaciones %}
              <tr data-id="{{ c.id }}" class="status-row {{ c.estatus|lower }}">
                <td>{{ c.folio }}</td>
                <td>{{ c.fecha.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ c.cliente.nombre_cliente if c.cliente else '' }}</td>
                <td>{{ c.cliente.empresa if c.cliente else '' }}</td>
                <td>${{ "{:,.2f}".format(c.total) }}</td>
                <td>
                  <select class="status-select" onchange="cambiarEstatus({{ c.id }}, this)">
                    {% for estado in ['PENDIENTE','ENVIADA','GANADA','PERDIDA'] %}
                      <option value="{{ estado }}" {% if c.estatus == estado %}selected{% endif %}>{{ estado }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <a href="{{ url_for('view_cotizacion', cot_id=c.id) }}" class="btn btn-outline-primary btn-sm">üëÅÔ∏è Ver</a>
                  <a href="{{ url_for('export_cotizacion_pdf', cot_id=c.id) }}" target="_blank" class="btn btn-outline-danger btn-sm">üìÑ PDF</a>
                  <a href="{{ url_for('export_cotizacion_xlsx', cot_id=c.id) }}" class="btn btn-outline-success btn-sm">üìä Excel</a>
                  <a href="{{ url_for('editar_cotizacion', cot_id=c.id) }}" class="btn btn-outline-warning btn-sm">‚úèÔ∏è Editar</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- üìà SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // === CAMBIO DE ESTATUS INLINE ===
    async function cambiarEstatus(id, select) {
      const nuevo = select.value;
      try {
        const res = await fetch(`/api/cotizaciones/${id}/estatus`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ estatus: nuevo }),
        });
        const data = await res.json();
        if (data.ok) {
          Swal.fire({
            icon: "success",
            title: "Estatus actualizado",
            text: `Nuevo estatus: ${nuevo}`,
            timer: 1200,
            showConfirmButton: false
          });
          actualizarColorFila(select.closest("tr"), nuevo);
        }
      } catch (err) {
        console.error(err);
      }
    }

    function actualizarColorFila(row, estatus) {
      row.classList.remove("table-success", "table-warning", "table-info", "table-danger");
      switch (estatus) {
        case "GANADA": row.classList.add("table-success"); break;
        case "PENDIENTE": row.classList.add("table-warning"); break;
        case "ENVIADA": row.classList.add("table-info"); break;
        case "PERDIDA": row.classList.add("table-danger"); break;
      }
    }

    // === GR√ÅFICAS ===
    async function cargarGraficas() {
      try {
        const res1 = await fetch("/api/dashboard/metrics");
        const data1 = await res1.json();

        const labels = data1.series.map(x => x.mes);
        const totales = data1.series.map(x => x.total);
        const cotizaciones = data1.series.map(x => x.cotizaciones);

        new Chart(document.getElementById("chartMensual"), {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Importe Total ($)",
                data: totales,
                backgroundColor: "#0d47a1",
                borderRadius: 6,
              },
              {
                label: "Cotizaciones",
                data: cotizaciones,
                backgroundColor: "#4caf50",
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
          },
        });

        const res2 = await fetch("/api/dashboard/status_breakdown");
        const data2 = await res2.json();

        new Chart(document.getElementById("chartEstatus"), {
          type: "doughnut",
          data: {
            labels: data2.labels,
            datasets: [{
              data: data2.counts,
              backgroundColor: ["#4caf50", "#ffeb3b", "#2196f3", "#f44336"],
            }],
          },
          options: { plugins: { legend: { position: "bottom" } } },
        });
      } catch (err) {
        console.error("Error cargando gr√°ficas", err);
      }
    }

    document.addEventListener("DOMContentLoaded", cargarGraficas);
  </script>

</body>
</html>
