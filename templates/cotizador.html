{% extends "base.html" %}
{% block content %}

<h2 class="mb-4 fw-bold text-primary">💰 Cotizador de Poliutech</h2>

<form id="frm-cotizacion" method="POST" action="{{ url_for('crear_cotizacion') }}">
  <!-- DATOS DEL CLIENTE -->
  <section class="panel mb-4">
    <h5 class="mb-3 text-secondary">Datos del Cliente</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <label for="cliente" class="form-label fw-semibold">Cliente</label>
        <input type="text" id="cliente" name="cliente" class="form-control" required placeholder="Nombre del cliente" autocomplete="off">
        <div id="cliente_suggestions" class="list-group position-absolute w-100"></div>
      </div>
      <div class="col-md-6">
        <label for="empresa" class="form-label fw-semibold">Empresa</label>
        <input type="text" id="empresa" name="empresa" class="form-control" placeholder="Empresa o razón social">
      </div>
    </div>
  </section>

  <!-- LISTA DE CONCEPTOS -->
  <section class="panel mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="text-secondary mb-0">Conceptos de Cotización</h5>
      <button type="button" class="btn btn-outline-primary btn-sm" id="btn-add-item">➕ Agregar Concepto</button>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered align-middle" id="tbl-items">
        <thead class="table-light">
          <tr>
            <th>Concepto</th>
            <th>Unidad</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Sistema</th>
            <th>Subtotal</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% if cotizacion and cotizacion.detalles %}
            {% for item in cotizacion.detalles %}
            <tr>
              <td><input type="text" name="concepto[]" value="{{ item.nombre_concepto }}" class="form-control concepto" required></td>
              <td><input type="text" name="unidad[]" value="{{ item.unidad }}" class="form-control"></td>
              <td><input type="number" name="cantidad[]" step="0.01" value="{{ item.cantidad }}" class="form-control cantidad"></td>
              <td><input type="number" name="precio_unitario[]" step="0.01" value="{{ item.precio_unitario }}" class="form-control precio_unitario"></td>
              <td><input type="number" name="descuento[]" step="0.01" value="{{ item.descuento }}" class="form-control" placeholder="Sistema"></td>
              <td><input type="text" name="subtotal[]" readonly value="{{ item.subtotal }}" class="form-control-plaintext subtotal"></td>
              <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger btn-del">✖</button>
              </td>
            </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- TOTALES -->
  <section class="panel mb-4">
    <div class="row g-3 text-end">
      <div class="col-md-4 ms-auto">
        <label class="form-label fw-semibold">Subtotal:</label>
        <input type="text" id="subtotal" name="subtotal" readonly class="form-control-plaintext text-end" value="0.00">
      </div>
      <div class="col-md-4 ms-auto">
        <label class="form-label fw-semibold">IVA (16%):</label>
        <input type="text" id="iva" name="iva" readonly class="form-control-plaintext text-end" value="0.00">
      </div>
      <div class="col-md-4 ms-auto">
        <label class="form-label fw-semibold">Total:</label>
        <input type="text" id="total" name="total" readonly class="form-control-plaintext fw-bold text-success text-end" value="0.00">
      </div>
    </div>
  </section>

  <!-- BOTONES -->
  <div class="d-flex justify-content-between">
    <button type="submit" class="btn btn-success fw-bold px-4">💾 Guardar Cotización</button>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">⬅ Volver al Dashboard</a>
  </div>
</form>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{{ url_for('static', filename='js/cotizador.js') }}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const table = document.getElementById("tbl-items");
  const btnAdd = document.getElementById("btn-add-item");

  // === AGREGAR NUEVA FILA ===
  btnAdd.addEventListener("click", () => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" name="concepto[]" class="form-control concepto" required></td>
      <td><input type="text" name="unidad[]" class="form-control"></td>
      <td><input type="number" name="cantidad[]" step="0.01" value="1" class="form-control cantidad"></td>
      <td><input type="number" name="precio_unitario[]" step="0.01" value="0.00" class="form-control precio_unitario"></td>
      <td><input type="number" name="descuento[]" step="0.01" value="0.00" class="form-control" placeholder="Sistema"></td>
      <td><input type="text" name="subtotal[]" readonly value="0.00" class="form-control-plaintext subtotal"></td>
      <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger btn-del">✖</button></td>
    `;
    table.querySelector("tbody").appendChild(row);
  });

  // === ELIMINAR FILA ===
  table.addEventListener("click", e => {
    if (e.target.classList.contains("btn-del")) {
      e.target.closest("tr").remove();
      recalcularTotales();
    }
  });

  // === RECALCULAR AUTOMÁTICO ===
  table.addEventListener("input", e => {
    if (["cantidad", "precio_unitario", "descuento"].some(c => e.target.classList.contains(c))) {
      recalcularTotales();
    }
  });

  function recalcularTotales() {
    let subtotal = 0;
    table.querySelectorAll("tbody tr").forEach(tr => {
      const cant = parseFloat(tr.querySelector(".cantidad")?.value) || 0;
      const precio = parseFloat(tr.querySelector(".precio_unitario")?.value) || 0;
      const descuento = parseFloat(tr.querySelector("[name='descuento[]']")?.value) || 0;
      const sub = (cant * precio) - descuento;
      const subtotalField = tr.querySelector(".subtotal");
      if (subtotalField) subtotalField.value = sub.toFixed(2);
      subtotal += sub;
    });

    const iva = subtotal * 0.16;
    const total = subtotal + iva;

    document.getElementById("subtotal").value = subtotal.toFixed(2);
    document.getElementById("iva").value = iva.toFixed(2);
    document.getElementById("total").value = total.toFixed(2);
  }

  recalcularTotales();
});
</script>

{% endblock %}
